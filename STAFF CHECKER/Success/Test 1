--========================================================--
-- MOD PRESENCE HUD (REAL PNG ‚Äì GUARANTEED DOWNLOAD)
-- gethui only ‚Ä¢ no CoreGui ‚Ä¢ safe re-exec
--========================================================--

local Players     = game:GetService("Players")
local HttpService = game:GetService("HttpService")

--========================================================--
-- CONFIG
--========================================================--

local MOD_USERIDS = {
    9724991729, 9954329834, -- add more if needed
}

local FOLDER = "mod_avatars"

local TEXT_JOINED  = "üö® MOD JOINED THE SERVER"
local TEXT_PRESENT = "üõ°Ô∏è MOD CURRENTLY IN SERVER"
local TEXT_ABSENT  = "‚ùå NO MOD IN SERVER"

-- HUD position (top middle)
local HUD_POSITION = UDim2.fromScale(0.5, 0.06)
local HUD_SIZE     = UDim2.fromOffset(260, 120)

--========================================================--
-- REQUIREMENTS
--========================================================--

local hui = gethui and gethui()
assert(hui, "gethui() not supported")

local asset = getsynasset or getcustomasset or error("No asset bridge")

assert(writefile and isfile and delfile, "file funcs missing")
assert(makefolder and isfolder, "folder funcs missing")

if not isfolder(FOLDER) then
    makefolder(FOLDER)
end

--========================================================--
-- SAFE RE-EXEC
--========================================================--

if getgenv().MOD_PRESENCE_HUD then
    local old = getgenv().MOD_PRESENCE_HUD
    if old.gui then old.gui:Destroy() end
end

getgenv().MOD_PRESENCE_HUD = {}

--========================================================--
-- GUI
--========================================================--

local gui = Instance.new("ScreenGui")
gui.Name = "ModPresenceHUD"
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.DisplayOrder = 1e9
gui.ZIndexBehavior = Enum.ZIndexBehavior.Global
gui.Parent = hui

if syn and syn.protect_gui then
    pcall(syn.protect_gui, gui)
end

getgenv().MOD_PRESENCE_HUD.gui = gui

local frame = Instance.new("Frame", gui)
frame.AnchorPoint = Vector2.new(0.5, 0)
frame.Position = HUD_POSITION
frame.Size = HUD_SIZE
frame.BackgroundColor3 = Color3.fromRGB(15,15,15)
frame.BorderSizePixel = 0
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

local stroke = Instance.new("UIStroke", frame)
stroke.Thickness = 2
stroke.Color = Color3.fromRGB(255,80,80)

local avatar = Instance.new("ImageLabel", frame)
avatar.BackgroundTransparency = 1
avatar.Size = UDim2.fromOffset(64,64)
avatar.Position = UDim2.fromOffset(10,10)
avatar.ScaleType = Enum.ScaleType.Fit
avatar.ZIndex = 50
avatar.Image = ""

local text = Instance.new("TextLabel", frame)
text.BackgroundTransparency = 1
text.Position = UDim2.fromOffset(84,18)
text.Size = UDim2.new(1,-94,0,40)
text.Font = Enum.Font.GothamBold
text.TextSize = 14
text.TextWrapped = true
text.TextXAlignment = Enum.TextXAlignment.Left
text.TextYAlignment = Enum.TextYAlignment.Center
text.TextColor3 = Color3.fromRGB(255,200,200)
text.Text = TEXT_ABSENT
text.ZIndex = 50

--========================================================--
-- ‚úÖ CORRECT AVATAR DOWNLOAD (YOUR METHOD)
--========================================================--

local PNG_SIG = "\137PNG\r\n\26\n"

local function avatarPath(userId)
    return string.format("%s/%d.png", FOLDER, userId)
end

local function downloadAvatar(userId)
    local api =
        ("https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=%d&size=150x150&format=Png&isCircular=false")
        :format(userId)

    local response = HttpService:JSONDecode(game:HttpGet(api))

    local imageUrl = response.data
        and response.data[1]
        and response.data[1].imageUrl

    if not imageUrl then
        warn("[MOD HUD] Failed to get imageUrl")
        return nil
    end

    local pngData = game:HttpGet(imageUrl)

    if pngData:sub(1,8) ~= PNG_SIG then
        warn("[MOD HUD] Invalid PNG downloaded")
        return nil
    end

    local path = avatarPath(userId)

    if isfile(path) then
        delfile(path)
    end

    writefile(path, pngData)
    return path
end

--========================================================--
-- APPLY AVATAR (EXECUTOR-SAFE)
--========================================================--

local function setAvatar(path)
    avatar.Image = ""

    if not (path and isfile(path)) then
        return
    end

    task.wait()

    local ok, assetId = pcall(asset, path)
    if not ok then
        warn("[MOD HUD] asset() failed:", assetId)
        return
    end

    avatar.Image = assetId
    task.wait()
    avatar.Image = assetId
end

--========================================================--
-- MOD PRESENCE LOGIC
--========================================================--

local function refresh()
    for _, p in ipairs(Players:GetPlayers()) do
        if table.find(MOD_USERIDS, p.UserId) then
            text.Text = TEXT_PRESENT

            local path = downloadAvatar(p.UserId)
            task.wait()
            setAvatar(path)
            return
        end
    end

    text.Text = TEXT_ABSENT
    setAvatar(nil)
end

--========================================================--
-- EVENTS
--========================================================--

task.defer(refresh)

Players.PlayerAdded:Connect(function(p)
    if table.find(MOD_USERIDS, p.UserId) then
        text.Text = TEXT_JOINED
        task.delay(1, refresh)
    end
end)

Players.PlayerRemoving:Connect(function(p)
    if table.find(MOD_USERIDS, p.UserId) then
        task.delay(0.5, refresh)
    end
end)
